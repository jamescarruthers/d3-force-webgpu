<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>D3 Force WebGPU Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    
    #container {
      display: flex;
      gap: 20px;
    }
    
    .canvas-wrapper {
      border: 1px solid #ccc;
      position: relative;
    }
    
    canvas {
      display: block;
    }
    
    .label {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 5px 10px;
      font-weight: bold;
    }
    
    #controls {
      margin-bottom: 20px;
    }
    
    button {
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
    }
    
    #status {
      margin-top: 20px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px;
    }
    
    .error {
      color: red;
    }
    
    .success {
      color: green;
    }
  </style>
</head>
<body>
  <h1>D3 Force Layout: CPU vs WebGPU Comparison</h1>
  
  <div id="controls">
    <button id="startBtn">Start Simulation</button>
    <button id="stopBtn">Stop Simulation</button>
    <button id="resetBtn">Reset</button>
    <label>
      Node Count: 
      <select id="nodeCount">
        <option value="100">100 nodes</option>
        <option value="500" selected>500 nodes</option>
        <option value="1000">1000 nodes</option>
        <option value="2000">2000 nodes</option>
        <option value="5000">5000 nodes</option>
      </select>
    </label>
  </div>
  
  <div id="container">
    <div class="canvas-wrapper">
      <div class="label">CPU (Original)</div>
      <canvas id="cpuCanvas" width="600" height="600"></canvas>
    </div>
    <div class="canvas-wrapper">
      <div class="label">WebGPU</div>
      <canvas id="gpuCanvas" width="600" height="600"></canvas>
    </div>
  </div>
  
  <div id="status"></div>

  <script type="module">
    import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';
    import { forceSimulation, forceManyBody, forceCenter } from '../src/index.js';
    import { forceSimulationGPU, forceManyBodyGPU, forceCenterGPU } from '../src/index-gpu.js';
    
    const width = 600;
    const height = 600;
    const cpuCanvas = document.getElementById('cpuCanvas');
    const gpuCanvas = document.getElementById('gpuCanvas');
    const cpuCtx = cpuCanvas.getContext('2d');
    const gpuCtx = gpuCanvas.getContext('2d');
    const statusEl = document.getElementById('status');
    
    let cpuSimulation, gpuSimulation;
    let nodes = [];
    let cpuFPS = 0, gpuFPS = 0;
    let cpuFrameCount = 0, gpuFrameCount = 0;
    let lastFPSUpdate = performance.now();
    
    function createNodes(count) {
      return Array.from({length: count}, (_, i) => ({
        id: i,
        x: Math.random() * width,
        y: Math.random() * height,
        vx: 0,
        vy: 0
      }));
    }
    
    function drawNodes(ctx, nodes, color = '#69b3a2') {
      ctx.clearRect(0, 0, width, height);
      
      ctx.fillStyle = color;
      nodes.forEach(node => {
        ctx.beginPath();
        ctx.arc(node.x, node.y, 3, 0, 2 * Math.PI);
        ctx.fill();
      });
    }
    
    async function initSimulations() {
      const nodeCount = parseInt(document.getElementById('nodeCount').value);
      nodes = createNodes(nodeCount);
      
      // CPU Simulation
      const cpuNodes = nodes.map(n => ({...n}));
      cpuSimulation = forceSimulation(cpuNodes)
        .force('charge', forceManyBody().strength(-30))
        .force('center', forceCenter(width / 2, height / 2))
        .alphaDecay(0.02)
        .on('tick', () => {
          drawNodes(cpuCtx, cpuNodes, '#69b3a2');
          cpuFrameCount++;
        });
      
      // GPU Simulation
      try {
        const gpuNodes = nodes.map(n => ({...n}));
        gpuSimulation = forceSimulationGPU(gpuNodes)
          .force('charge', forceManyBodyGPU().strength(-30))
          .force('center', forceCenterGPU(width / 2, height / 2))
          .alphaDecay(0.02)
          .on('tick', () => {
            drawNodes(gpuCtx, gpuNodes, '#e85d75');
            gpuFrameCount++;
          });
        
        statusEl.innerHTML = '<span class="success">WebGPU initialized successfully!</span>';
      } catch (error) {
        statusEl.innerHTML = `<span class="error">WebGPU Error: ${error.message}</span>`;
        console.error('WebGPU initialization failed:', error);
      }
    }
    
    function updateFPS() {
      const now = performance.now();
      const elapsed = now - lastFPSUpdate;
      
      if (elapsed >= 1000) {
        cpuFPS = Math.round(cpuFrameCount * 1000 / elapsed);
        gpuFPS = Math.round(gpuFrameCount * 1000 / elapsed);
        
        statusEl.innerHTML = `
          <strong>Performance:</strong><br>
          CPU FPS: ${cpuFPS}<br>
          GPU FPS: ${gpuFPS}<br>
          Speedup: ${gpuFPS > 0 ? (gpuFPS / cpuFPS).toFixed(2) + 'x' : 'N/A'}
        `;
        
        cpuFrameCount = 0;
        gpuFrameCount = 0;
        lastFPSUpdate = now;
      }
      
      requestAnimationFrame(updateFPS);
    }
    
    // Event handlers
    document.getElementById('startBtn').addEventListener('click', async () => {
      await initSimulations();
      if (cpuSimulation) cpuSimulation.restart();
      if (gpuSimulation) gpuSimulation.restart();
      updateFPS();
    });
    
    document.getElementById('stopBtn').addEventListener('click', () => {
      if (cpuSimulation) cpuSimulation.stop();
      if (gpuSimulation) gpuSimulation.stop();
    });
    
    document.getElementById('resetBtn').addEventListener('click', async () => {
      if (cpuSimulation) cpuSimulation.stop();
      if (gpuSimulation) {
        gpuSimulation.stop();
        gpuSimulation.destroy();
      }
      cpuCtx.clearRect(0, 0, width, height);
      gpuCtx.clearRect(0, 0, width, height);
      statusEl.innerHTML = '';
    });
    
    document.getElementById('nodeCount').addEventListener('change', async () => {
      document.getElementById('resetBtn').click();
    });
    
    // Check WebGPU support
    if (!navigator.gpu) {
      statusEl.innerHTML = '<span class="error">WebGPU is not supported in this browser!</span>';
    } else {
      statusEl.innerHTML = '<span class="success">WebGPU is available. Click "Start Simulation" to begin.</span>';
    }
  </script>
</body>
</html>